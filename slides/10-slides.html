<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Relationships</title>
    <meta charset="utf-8" />
    <meta name="author" content="Todd Gerarden" />
    <script src="libs/header-attrs-2.20/header-attrs.js"></script>
    <link href="libs/tile-view-0.2.6/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view-0.2.6/tile-view.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="css/tdg-slides.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">








class: center middle main-title section-title-4

# Relationships

.class-info[

**Week 10**

AEM 2850 / 5850 : R for Business Analytics&lt;br&gt;
Cornell Dyson&lt;br&gt;
Spring 2023

Acknowledgements: 
[Andrew Heiss](https://datavizm20.classes.andrewheiss.com)
&lt;!-- [Claus Wilke](https://wilkelab.org/SDS375/) --&gt;
&lt;!-- [Grant McDermott](https://github.com/uo-ec607/lectures), --&gt;
&lt;!-- [Jenny Bryan](https://stat545.com/join-cheatsheet.html), --&gt;
&lt;!-- [Allison Horst](https://github.com/allisonhorst/stats-illustrations) --&gt;

]

---

# Announcements

Reminders:
- Group project due April 14 ([link](https://aem2850.toddgerarden.com/assignment/group-project/))
  - We set up group-specific workspaces on Posit Cloud for the project to allow simultaneous collaborative editing
  - Instructions are posted there and on canvas
  - Make a plan and start early!
- Local R install instructions posted ([link](https://aem2850.toddgerarden.com/resource/install/))
  - You are welcome to work locally if that's what your group prefers

Questions before we get started?

---

# Plan for today

&lt;!-- [Prologue](#prologue) --&gt;

[Prologue: The dangers of dual y-axes](#dual-y-axes)

[Visualizing correlations](#correlations)

[Visualizing regressions](#regressions)


---
class: inverse, center, middle
name: dual-y-axes

# Prologue: The dangers of dual y-axes

---

# Oh no!

.small.center[
&lt;figure&gt;
  &lt;img src="img/10/chart.png" alt="Spurious correlation between deaths by drowning and the number of films Nicolas Cage appeared in" title="Spurious correlation between deaths by drowning and the number of films Nicolas Cage appeared in" width="100%"&gt;
  &lt;figcaption&gt;Source: &lt;a href="https://www.tylervigen.com/spurious-correlations" target="_blank"&gt;Tyler Vigen's spurious correlations&lt;/a&gt;&lt;/figcaption&gt;
&lt;/figure&gt;
]

---

# Why not use two y-axes?

--

You have to choose where the y-axes start and stop, which means...

--

...you can force the two trends to line up however you want!


---

# It even happens in *The Economist*!

.center[
&lt;figure&gt;
  &lt;img src="img/10/economist-dogs.png" alt="Dog neck size and weight in The Economist" title="Dog neck size and weight in The Economist" width="80%"&gt;
&lt;/figure&gt;

The revised axes ranges reflect a comparable proportional change
]

???

&lt;https://medium.economist.com/mistakes-weve-drawn-a-few-8cdd8a42d368&gt;

---

# The rare triple y-axis

.small.center[
&lt;figure&gt;
  &lt;img src="img/10/triple-y-axis.png" alt="Acemoglu and Restrepo triple y-axis" title="Acemoglu and Restrepo triple y-axis" width="60%"&gt;
  &lt;figcaption&gt;Source: Daron Acemoglu and Pascual Restrepo, "The Race Between Man and Machine: Implications of Technology for Growth, Factor Shares and Employment"&lt;/figcaption&gt;
&lt;/figure&gt;
]

???

Daron Acemoglu and Pascual Restrepo, ["The Race Between Man and Machine: Implications of Technology for Growth, Factor Shares and Employment"](https://economics.mit.edu/files/10866)

---

# What could we do instead?

--

Use multiple plots!

.center[
&lt;figure&gt;
  &lt;figcaption&gt;Solar panels in Japan&lt;/figcaption&gt;
  &lt;img src="img/10/solar-innovation-Japan.png" alt="Japanese solar market timeline" title="Japanese solar market timeline" width="65%"&gt;
&lt;/figure&gt;
]

???

Source: Gerarden (2021) "Demanding Innovation: The Impact of Consumer Subsidies on Solar Panel Production Costs"

---

# How could we make multiple plots in R?

--

**1. Facets** are great when using a common geometry (we've already seen that)

**2. Combining multiple plot objects** can be more flexible

--

Let's use Ithaca weather data to see an example of combining plots:


```r
ithaca_weather &lt;- read_csv("data/ithaca-weather-2021.csv")

ithaca_weather |&gt; 
  select(STATION, NAME, DATE, TMAX, SNOW) |&gt; 
  head(3)
```

```
## # A tibble: 3 × 5
##   STATION     NAME                             DATE        TMAX  SNOW
##   &lt;chr&gt;       &lt;chr&gt;                            &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;
## 1 USC00304174 ITHACA CORNELL UNIVERSITY, NY US 2021-01-01    33     0
## 2 USC00304174 ITHACA CORNELL UNIVERSITY, NY US 2021-01-02    40     0
## 3 USC00304174 ITHACA CORNELL UNIVERSITY, NY US 2021-01-03    42     0
```


---

# Combining multiple plots in R

.left-code[

```r
*library(patchwork)

# make a plot of temperatures
temp_plot &lt;- ggplot(ithaca_weather, 
                    aes(x = DATE, y = TMAX)) +
  geom_line() + geom_smooth() +
  labs(x = NULL, y = "Fahrenheit")

# make a plot of snowfall
snow_plot &lt;- ggplot(ithaca_weather,   
                    aes(x = DATE, y = SNOW)) + 
  geom_col() + 
  labs(x = NULL, y = "Snowfall (inches)")

*# use patchwork to combine the two plots
*temp_plot +    # simply use + to combine plots
* snow_plot +  # then add on custom options
* plot_layout(ncol = 1,
*             heights = c(0.7, 0.3))
```
]

--

.right-plot[
![](10-slides_files/figure-html/ithaca-weather-patchwork-1.png)
]


---

# When are dual y-axes defensible?

--

When the two axes measure the same thing

--

&lt;img src="10-slides_files/figure-html/ithaca-weather-dual-nice-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

# Making the base plot in R

.left-code[

```r
ggplot(ithaca_weather, 
       aes(x = DATE, y = TMAX)) +
* geom_line() +
* geom_smooth() +
  labs(x = NULL, y = "Fahrenheit")
```

How could we add a second axis?

Do any functions come to mind?
]

.right-plot[
![](10-slides_files/figure-html/ithaca-weather-single-1.png)
]

---

# Adding a second scale in R

.left-code[

```r
ggplot(ithaca_weather, 
       aes(x = DATE, y = TMAX)) +
  geom_line() +
  geom_smooth() +
* scale_y_continuous(
*   sec.axis =
*     sec_axis(trans = ~ (. - 32) * 5/9,
*              name = "Celsius")
* ) +
  labs(x = NULL, y = "Fahrenheit")
```

We provided this formula for the **trans**formation argument:

.small.center[`Celsius = (Fahrenheit - 32) * 5/9`]
]

.right-plot[
![](10-slides_files/figure-html/ithaca-weather-dual-1.png)
]

---

# Adding a second scale in R

.left-code[

```r
car_counts &lt;- mpg |&gt; 
  group_by(drv) |&gt; summarize(total = n())

total_cars &lt;- sum(car_counts$total)

ggplot(car_counts,
       aes(x = drv, y = total, fill = drv)) +
  geom_col() +
* scale_y_continuous(
*   sec.axis = sec_axis(
*     trans = ~ . / total_cars,
*     labels = scales::percent)) +
  guides(fill = "none")
```
This makes it a lot easier to see proportions with side-by-side bars!

Note: **total_cars** is not in **car_counts**
]

.right-plot[
![](10-slides_files/figure-html/cars-dual-1.png)
]

---

class: inverse, center, middle
name: correlations

# Visualizing correlations

---

# What does "correlation" mean to you?

--

As the value of X goes up, Y tends to go up (down) a lot / a little / not at all

$$
\rho_{X, Y} = \frac{\operatorname{cov}(X, Y)}{\sigma_X \sigma_Y}
$$

Says nothing about *how much* Y changes when X changes

---

# Correlation values

.pull-left[
&amp;nbsp;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th class="cell-left"&gt;$$\rho$$&lt;/th&gt;
    &lt;th class="cell-left"&gt;Rough meaning&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="cell-left"&gt;±0.1–0.3&amp;emsp;&lt;/td&gt;
    &lt;td class="cell-left"&gt;Weak&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="cell-left"&gt;±0.3–0.5&lt;/td&gt;
    &lt;td class="cell-left"&gt;Moderate&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="cell-left"&gt;±0.5–0.8&lt;/td&gt;
    &lt;td class="cell-left"&gt;Strong&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class="cell-left"&gt;±0.8–0.9&lt;/td&gt;
    &lt;td class="cell-left"&gt;Very strong&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
]

.pull-right[

&lt;img src="10-slides_files/figure-html/correlation-grid-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]


---

# Scatter plots

The humble scatter plot is often the best place to start when studying the association between two variables

--

**Example:** max and min temperature in Ithaca each day of the year
  - Do you think they are highly correlated, somewhat correlated, or not at all correlated?
  - What sign do you think this correlation has?
  - How would you make a scatter plot of these data in R?

---

# Scatter plots

.left-code[

```r
ithaca_weather |&gt; 
  ggplot(aes(x = TMIN, y = TMAX)) +
  geom_point()
```

```r
cor(ithaca_weather$TMIN, 
    ithaca_weather$TMAX) |&gt; 
  round(3)
```

```
## [1] 0.919
```

**Strong positive correlation**
]

.right-plot[
![](10-slides_files/figure-html/ithaca-weather-scatterplot-1-1.png)
]

---

# What about min temp and snowfall?

--

.left-code[

```r
ithaca_weather |&gt; 
  ggplot(aes(x = TMIN, y = SNOW)) +
  geom_point()
```

```r
cor(ithaca_weather$TMIN, 
    ithaca_weather$SNOW) |&gt; 
  round(3)
```

```
## [1] -0.239
```

**Weak negative correlation**
]

.right-plot[
![](10-slides_files/figure-html/ithaca-weather-scatterplot-2-1.png)
]

---
  
# Scatter plot matrices

--

.left-code[

```r
library(GGally)

cars_smaller &lt;- mtcars |&gt; 
  select(disp, hp, mpg)

ggpairs(cars_smaller)
```
Scatter plots can be scaled up to matrices for several variables

For many variables, correlograms or correlation coefficients often better

]

.right-plot[
  ![](10-slides_files/figure-html/scatterplot-matrix-1.png)
]

---

# Correlograms: Heatmaps

&lt;img src="10-slides_files/figure-html/cor-heatmap-1.png" width="100%" style="display: block; margin: auto;" /&gt;


---

# Correlograms: Points

&lt;img src="10-slides_files/figure-html/cor-points-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

class: inverse, center, middle
name: regressions

# Visualizing regressions

---

# Linear regression reminder

$$
y = \beta_0 + \beta_1 x_1 + \varepsilon
$$

&lt;table&gt;
  &lt;tr&gt;
    &lt;!-- &lt;td class="cell-center"&gt;\(y\)&lt;/td&gt; --&gt;
    &lt;td class="cell-center"&gt;\(y\)&lt;/td&gt;
    &lt;td class="cell-left"&gt;&amp;ensp;Outcome variable (DV)&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;!-- &lt;td class="cell-center"&gt;\(x\)&lt;/td&gt; --&gt;
    &lt;td class="cell-center"&gt;\(x_1\)&lt;/td&gt;
    &lt;td class="cell-left"&gt;&amp;ensp;Explanatory variable (IV)&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;!-- &lt;td class="cell-center"&gt;\(a\)&lt;/td&gt; --&gt;
    &lt;td class="cell-center"&gt;\(\beta_1\)&lt;/td&gt;
    &lt;td class="cell-left"&gt;&amp;ensp;Slope&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;!-- &lt;td class="cell-center"&gt;\(b\)&lt;/td&gt; --&gt;
    &lt;td class="cell-center"&gt;\(\beta_0\)&lt;/td&gt;
    &lt;td class="cell-left"&gt;&amp;ensp;y-intercept&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;!-- &lt;td class="cell-center"&gt;&amp;emsp;&amp;emsp;&lt;/td&gt; --&gt;
    &lt;td class="cell-center"&gt;&amp;emsp;\(\varepsilon\)&amp;emsp;&lt;/td&gt;
    &lt;td class="cell-left"&gt;&amp;ensp;Error (residuals)&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

---

# Linear regression is just drawing lines

.pull-left[

&lt;img src="10-slides_files/figure-html/cars-line-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

--

.pull-right[

&lt;img src="10-slides_files/figure-html/cars-residuals-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

---

# Building models in R

Base R has some basic modeling tools:

```r
name_of_model &lt;- lm(&lt;Y&gt; ~ &lt;X&gt;, data = &lt;DATA&gt;) # use lm to fit simple linear models

summary(name_of_model) # see model details
```

--

The `broom` package provides helpful tools for tidying model output:

```r
library(broom)

# convert model estimates to a data frame for plotting
tidy(name_of_model)

# return a data frame that includes predictions, residuals, etc.
augment(name_of_model)
```

---

# Modeling displacement and highway MPG

.pull-left[
$$
\text{hwy} = \beta_0 + \beta_1 \text{displ} + \varepsilon
$$


```r
car_model &lt;- lm(hwy ~ displ,
                data = mpg)
```

Note how we didn't write anything for the `\(\beta_0\)` or `\(\varepsilon\)` terms

What do you think the sign on `\(\beta_1\)` is?

]

--

.pull-right[

```r
car_model
```

```
## 
*## Call:
*## lm(formula = hwy ~ displ, data = mpg)
## 
*## Coefficients:
*## (Intercept)        displ  
*##      35.698       -3.531
```
]

---

# Modeling displacement and highway MPG

```r
summary(car_model)
```

```
## 
*## Call:
*## lm(formula = hwy ~ displ, data = mpg)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -7.1039 -2.1646 -0.2242  2.0589 15.0105 
## 
*## Coefficients:
*##             Estimate Std. Error t value Pr(&gt;|t|)    
*## (Intercept)  35.6977     0.7204   49.55   &lt;2e-16 ***
*## displ        -3.5306     0.1945  -18.15   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 3.836 on 232 degrees of freedom
## Multiple R-squared:  0.5868,	Adjusted R-squared:  0.585 
## F-statistic: 329.5 on 1 and 232 DF,  p-value: &lt; 2.2e-16
```

---

# Modeling displacement and highway MPG


```r
tidy(car_model, conf.int = TRUE)
```

```
## # A tibble: 2 × 7
##   term        estimate std.error statistic   p.value conf.low conf.high
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)    35.7      0.720      49.6 2.12e-125    34.3      37.1 
## 2 displ          -3.53     0.195     -18.2 2.04e- 46    -3.91     -3.15
```

&lt;!-- -- --&gt;



---

# Interpretation for a continuous variable

$$
y = \beta_0 + \beta_1 x_1 + \varepsilon
$$

--

On average, a one unit increase in `\(x_1\)` is *associated* with a `\(\beta_1\)` change in `\(y\)`

--

$$
\text{hwy} = \beta_0 + \beta_1 \text{displ} + \varepsilon
$$

$$
\widehat{\text{hwy}} = 35.7 + (-3.53) \times \text{displ}
$$
On average, a one unit increase in displacement is associated with 3.53 lower highway fuel economy

--

**This is easy to visualize: it's a line!**

---

# Visualization of a continuous variable

.pull-left[

```r
tidy(car_model) |&gt; 
  select(term, estimate)
```

```
## # A tibble: 2 × 2
##   term        estimate
##   &lt;chr&gt;          &lt;dbl&gt;
## 1 (Intercept)    35.7 
## 2 displ          -3.53
```

$$
\widehat{\text{hwy}} = 35.7 + (-3.53) \times \text{displ}
$$
]

.pull-right[
&lt;img src="10-slides_files/figure-html/cars-line-again-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

---

# Visualization of a continuous variable

.pull-left[

```r
tidy(car_model) |&gt; 
  select(term, estimate)
```

```
## # A tibble: 2 × 2
##   term        estimate
##   &lt;chr&gt;          &lt;dbl&gt;
## 1 (Intercept)    35.7 
## 2 displ          -3.53
```

$$
\widehat{\text{hwy}} = 35.7 + (-3.53) \times \text{displ}
$$
]

.pull-right[
&lt;img src="10-slides_files/figure-html/cars-line-again-again-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

---

# Visualization of a continuous variable

.pull-left[
.small[Reminder: `geom_smooth(method = "lm")` allows us to skip the estimation step!]


```r
mpg |&gt; 
  ggplot(aes(x = displ, y = hwy)) +
  geom_point() +
  geom_smooth(
*   method = "lm",     # smoothing function
*   formula = "y ~ x", # optional in this case (default)
*   fullrange = TRUE,  # start line at 0
*   se = FALSE         # omit confidence bands
  ) +      
  scale_x_continuous(limits = c(0, 7)) +
  scale_y_continuous(limits = c(10, NA))
```
]

.pull-right[
&lt;img src="10-slides_files/figure-html/tidy-car-model-geom_smooth-plot-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---

# Multiple regression

We're not limited to just one explanatory variable!

--

$$
y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_n x_n + \varepsilon
$$

&amp;nbsp;

--


```r
car_model_big &lt;- lm(hwy ~ displ + cyl + drv,
                    data = mpg)
```

$$
\widehat{\text{hwy}} = \widehat{\beta}_0 + \widehat{\beta}_1 \text{displ} + \widehat{\beta}_2 \text{cyl} + \widehat{\beta}_3 \text{drv:f} + \widehat{\beta}_4 \text{drv:r}
$$

---

# Modeling lots of things and MPG

.small-code[

```r
tidy(car_model_big, conf.int = TRUE)
```

```
## # A tibble: 5 × 7
##   term        estimate std.error statistic  p.value conf.low conf.high
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)    33.1      1.03      32.1  9.49e-87    31.1     35.1  
## 2 displ          -1.12     0.461     -2.44 1.56e- 2    -2.03    -0.215
## 3 cyl            -1.45     0.333     -4.36 1.99e- 5    -2.11    -0.796
## 4 drvf            5.04     0.513      9.83 3.07e-19     4.03     6.06 
## 5 drvr            4.89     0.712      6.86 6.20e-11     3.48     6.29
```
]

--

$$
`\begin{aligned}
\widehat{\text{hwy}} =&amp;\ 33.1 + (-1.12) \times \text{displ} + (-1.45) \times \text{cyl} \ + \\
&amp;(5.04) \times \text{drv:f} + (4.89) \times \text{drv:r}
\end{aligned}`
$$

---

# Sliders and switches

.center[
&lt;figure&gt;
  &lt;img src="img/10/slider-switch-plain-80.jpg" alt="Switch and slider" title="Switch and slider" width="100%"&gt;
&lt;/figure&gt;
]

---

# Sliders and switches

.center[
&lt;figure&gt;
  &lt;img src="img/10/slider-switch-annotated-80.jpg" alt="Switch and slider" title="Switch and slider" width="100%"&gt;
&lt;/figure&gt;
]

---

# Interpretation for continuous variables

$$
y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_n x_n + \varepsilon
$$

--

***Holding everything else constant***, a one unit increase in `\(x_n\)` is *associated* with a `\(\beta_n\)` change in `\(y\)`, on average

--

$$
`\begin{aligned}
\widehat{\text{hwy}} =&amp;\ 33.1 + (-1.12) \times \text{displ} + (-1.45) \times \text{cyl} \ + \\
&amp;(5.04) \times \text{drv:f} + (4.89) \times \text{drv:r}
\end{aligned}`
$$

On average, a one unit increase in displacement is associated with 1.12 lower highway fuel economy, holding everything else constant

--

.tiny[
Aside: for the earlier model we had said

&gt; On average, a one unit increase in displacement is associated with 3.53 lower highway fuel economy
]

---

# Interpretation for categorical variables

$$
y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_n x_n + \varepsilon
$$

--

***Holding everything else constant***, `\(y\)` is `\(\beta_n\)` units larger (or smaller) for category `\(x_n\)` than for the omitted category, on average

$$
`\begin{aligned}
\widehat{\text{hwy}} =&amp;\ 33.1 + (-1.12) \times \text{displ} + (-1.45) \times \text{cyl} \ + \\
&amp;(5.04) \times \text{drv:f} + (4.89) \times \text{drv:r}
\end{aligned}`
$$

--

On average, front-wheel drive cars have 5.04 higher highway fuel economy than 4-wheel-drive cars, holding everything else constant

---

# Good luck visualizing all this!

&amp;nbsp;

.large[You can't just draw a single line! There are too many moving parts!]

---

# Main challenges

--

Each coefficient has its own estimate and standard errors

--

**Solution:** Plot the coefficients and their errors with a *coefficient plot*

--

The results change as you move each slider up and down and flip each switch on and off

--

**Solution:** Plot the *marginal effects* for the coefficients you're interested in

---

# Coefficient plots

Convert the model results to a data frame with `tidy()`

.small-code[

```r
car_model_big &lt;- lm(hwy ~ displ + cyl + drv, data = mpg)

car_coefs &lt;- tidy(car_model_big, conf.int = TRUE) |&gt; 
  filter(term != "(Intercept)")  # we typically skip plotting the intercept, so remove it
car_coefs
```

```
## # A tibble: 4 × 7
##   term  estimate std.error statistic  p.value conf.low conf.high
##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 displ    -1.12     0.461     -2.44 1.56e- 2    -2.03    -0.215
## 2 cyl      -1.45     0.333     -4.36 1.99e- 5    -2.11    -0.796
## 3 drvf      5.04     0.513      9.83 3.07e-19     4.03     6.06 
## 4 drvr      4.89     0.712      6.86 6.20e-11     3.48     6.29
```
]

---

# Coefficient plots

Plot the point estimate and confidence intervals with `geom_pointrange()`

.left-code[

```r
car_coefs |&gt; 
  ggplot(aes(x = estimate, 
             y = fct_rev(term))) +
  geom_pointrange(aes(xmin = conf.low, 
                      xmax = conf.high)) +
  geom_vline(xintercept = 0, color = "red")
```
]

.right-plot[
![](10-slides_files/figure-html/coef-plot-cars-1.png)
]

---

# Marginal effects plots

**Remember that we interpret individual coefficients while holding the others constant**

We move one slider while leaving all the other sliders and switches alone

--

**Same principle applies to visualizing the effect**

--

Plug a bunch of values into the model and find the predicted outcome

--

Plot the values and predicted outcome

---

# Marginal effects plots

Create a data frame of values you want to manipulate and values you want to hold constant

--

Must include all the explanatory variables in the model

---

# Marginal effects plots

.small-code[

```r
cars_new_data &lt;- tibble(displ = seq(2, 7, by = 0.1),  # create grid for displ
                        cyl = mean(mpg$cyl),          # hold cylinders at its mean
                        drv = "f")                    # drive: front-wheel

cars_new_data
```

```
## # A tibble: 51 × 3
##    displ   cyl drv  
##    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
##  1   2    5.89 f    
##  2   2.1  5.89 f    
##  3   2.2  5.89 f    
##  4   2.3  5.89 f    
##  5   2.4  5.89 f    
##  6   2.5  5.89 f    
##  7   2.6  5.89 f    
##  8   2.7  5.89 f    
##  9   2.8  5.89 f    
## 10   2.9  5.89 f    
## # … with 41 more rows
```
]

---

# Marginal effects plots

Plug each of those rows of data into the model with `augment()`


```r
predicted_mpg &lt;- augment(car_model_big,           # our estimated model
                         newdata = cars_new_data, # our new data for plotting
                         se_fit = TRUE)           # add standard errors for fitted values

head(predicted_mpg)
```

```
## # A tibble: 6 × 5
##   displ   cyl drv   .fitted .se.fit
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1   2    5.89 f        27.3   0.644
## 2   2.1  5.89 f        27.2   0.604
## 3   2.2  5.89 f        27.1   0.566
## 4   2.3  5.89 f        27.0   0.529
## 5   2.4  5.89 f        26.9   0.494
## 6   2.5  5.89 f        26.8   0.460
```

---

# Marginal effects plots

Plot the fitted values for each row

We made predictions for front-wheel drive cars with cylinders held at their mean

.left-code[

```r
predicted_mpg |&gt; 
  ggplot(aes(x = displ, y = .fitted)) +
  geom_line(color = "#B31B1B",
            linewidth = 1) +
  geom_ribbon(aes(ymin = .fitted + 
                    (-1.96 * .se.fit),
                  ymax = .fitted + 
                    (1.96 * .se.fit)),
              fill = "#B31B1B", 
              alpha = 0.5)
```
]

.right-plot[
![](10-slides_files/figure-html/mfx-plot-cars-1.png)
]

---

# Multiple effects at once

We can also move multiple sliders and switches at the same time!

--

What's the marginal effect of increasing displacement across the front-, rear-, and four-wheel drive cars?

--

How would you approach this?

---

# Multiple effects at once

Create a new dataset with varying displacement *and* varying drive, holding cylinders at its mean

The `expand_grid()` function comes in handy for this

--

`expand_grid()` creates a data frame with every possible combination of the variables you supply

---

# Multiple effects at once


```r
cars_new_data_fancy &lt;- expand_grid(displ = seq(2, 7, by = 0.1),  # create grid for displ
                                   cyl = mean(mpg$cyl),          # hold cylinders at its mean
                                   drv = c("f", "r", "4"))       # drive: front-wheel
                                   
cars_new_data_fancy
```

```
## # A tibble: 153 × 3
##    displ   cyl drv  
##    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
##  1   2    5.89 f    
##  2   2    5.89 r    
##  3   2    5.89 4    
##  4   2.1  5.89 f    
##  5   2.1  5.89 r    
##  6   2.1  5.89 4    
##  7   2.2  5.89 f    
##  8   2.2  5.89 r    
##  9   2.2  5.89 4    
## 10   2.3  5.89 f    
## # … with 143 more rows
```

---

# Multiple effects at once

Plug each of those rows of data into the model with `augment()`

.small-code[

```r
predicted_mpg_fancy &lt;- augment(car_model_big,                 # our estimated model
                               newdata = cars_new_data_fancy, # our new data for plotting
                               se_fit = TRUE)

head(predicted_mpg_fancy)
```

```
## # A tibble: 6 × 5
##   displ   cyl drv   .fitted .se.fit
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1   2    5.89 f        27.3   0.644
## 2   2    5.89 r        27.2   1.14 
## 3   2    5.89 4        22.3   0.805
## 4   2.1  5.89 f        27.2   0.604
## 5   2.1  5.89 r        27.1   1.10 
## 6   2.1  5.89 4        22.2   0.763
```
]

---

# Multiple effects at once

Plot the fitted values for each row

Cylinders held at their mean; colored/filled by drive

.left-code[

```r
predicted_mpg_fancy |&gt; 
  ggplot(aes(x = displ, y = .fitted)) +
  geom_ribbon(aes(ymin = .fitted + 
                    (-1.96 * .se.fit),
                  ymax = .fitted + 
                    (1.96 * .se.fit),
                  fill = drv),
              alpha = 0.5) +
  geom_line(aes(color = drv), linewidth = 1)
```
]

.right-plot[
![](10-slides_files/figure-html/mfx-plot-cars-fancy-1.png)
]

---

# Multiple effects at once

Plot the fitted values for each row

Cylinders held at their mean; colored/filled/facetted by drive

.left-code[

```r
predicted_mpg_fancy |&gt; 
  ggplot(aes(x = displ, y = .fitted)) +
  geom_ribbon(aes(ymin = .fitted + 
                    (-1.96 * .se.fit),
                  ymax = .fitted + 
                    (1.96 * .se.fit),
                  fill = drv),
              alpha = 0.5) +
  geom_line(aes(color = drv), linewidth = 1) + 
* guides(fill = "none", color = "none") +
* facet_wrap(vars(drv))
```
]

.right-plot[
![](10-slides_files/figure-html/mfx-plot-cars-fancy-facet-1.png)
]

---

# Estimating regressions with interactions

We can use **interactions** to estimate different slopes for each drive type

.pull-left[
.small[Syntax: `drv:displ` adds an interaction between `drv` and `displ`]

```r
car_model_interactions &lt;- lm(
* hwy ~ drv + drv:displ + cyl,
  data = mpg
)
```
.small[Alternatively: `drv*displ` adds `drv`, `displ`, and their interaction]
]

.pull-right[

```r
tidy(car_model_interactions) |&gt; 
  select(term, estimate)
```

```
## # A tibble: 7 × 2
##   term        estimate
##   &lt;chr&gt;          &lt;dbl&gt;
## 1 (Intercept)  32.5   
## 2 drvf          7.03  
## 3 drvr         -1.12  
## 4 cyl          -1.30  
*## 5 drv4:displ   -1.21  
*## 6 drvf:displ   -1.94  
*## 7 drvr:displ   -0.0645
```
]

---

# Even more effects at once!

.left-code[

```r
predicted_mpg_interactions &lt;- augment(
* car_model_interactions, # interacted model
  newdata = cars_new_data_fancy,
  se_fit = TRUE
)

predicted_mpg_interactions |&gt; 
  ggplot(aes(x = displ, y = .fitted)) +
  geom_ribbon(aes(ymin = .fitted + 
                    (-1.96 * .se.fit),
                  ymax = .fitted + 
                    (1.96 * .se.fit),
                  fill = drv),
              alpha = 0.5) +
  geom_line(aes(color = drv), linewidth = 1) + 
  guides(fill = "none", color = "none") +
  facet_wrap(vars(drv))
```
]

.right-plot[
![](10-slides_files/figure-html/mfx-plot-cars-interactions-1.png)

.small.center[**Note the different slopes!**]
]

---

# Not just OLS!

.box-inv-6[These plots are for an OLS model built with `lm()`]

.pull-left[
![](10-slides_files/figure-html/coef-plot-cars-1.png)
]

.pull-right[
![](10-slides_files/figure-html/mfx-plot-cars-fancy-facet-1.png)
]

---

# Any type of statistical model

The same techniques work for pretty much any model R can run

--

.small[OLS with high-dimensional fixed effects]

.small[Logistic, probit, and multinomial regression (ordered and unordered)]

.small[Multilevel (i.e., mixed and random effects) regression]

.small[Bayesian models]

.small[Machine learning models]

--

If it has coefficients and/or makes predictions, you can (and should) visualize it!
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"slideNumberFormat": "%current%",
"ratio": "16:9",
"navigation": {
"scroll": false
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
